<!DOCTYPE html>
<html>
  <head>
    <title>DB Visual Music Player</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <!-- Adding the new map code from Ammap -->
    <link rel="stylesheet" href="../ammap/ammap.css" type="text/css">  

    <!--for ajax and selectable stuff-->
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
  	<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
	<!--Style elements for SELECTABLE (change as required)-->
	<style>
	  #feedback { font-size: 1.4em; }
	  #selectable .ui-selecting { background: #FECA40; }
	  #selectable .ui-selected { background: #F39814; color: white; }
	  #selectable { list-style-type: none; margin: 0; padding: 0; width: 60%; }
	  #selectable li { margin: 3px; padding: 0.4em; font-size: 1.4em; height: 18px; }
	</style>    	
    
    <script src="../ammap/ammap.js" type="text/javascript"></script>
    <!-- map file should be included after ammap.js -->
	<script src="../ammap/maps/js/worldLow.js" type="text/javascript"></script>    
    <script type="text/javascript">
                
		// add all your code to this method, as this will ensure that page is loaded
		AmCharts.ready(function() {
		    // create AmMap object
		    var map = new AmCharts.AmMap();
		    // set path to images
		    map.pathToImages = "../ammap/images/";
		    
		    /* create data provider object
		     mapVar tells the map name of the variable of the map data. You have to
		     view source of the map file you included in order to find the name of the 
		     variable - it's the very first line after commented lines.
		     
		     getAreasFromMap indicates that amMap should read all the areas available
		     in the map data and treat them as they are included in your data provider.
		     in case you don't set it to true, all the areas except listed in data
		     provider will be treated as unlisted.
		    */
		    var dataProvider = {
		        mapVar: AmCharts.maps.worldLow,
		        getAreasFromMap:true                    
		    }; 
		    // pass data provider to the map object
		    map.dataProvider = dataProvider;
		
		    /* create areas settings
		     * autoZoom set to true means that the map will zoom-in when clicked on the area
		     * selectedColor indicates color of the clicked area.
		     */
		    map.areasSettings = {
		        autoZoom: true,
		        selectedColor: "#CC0000"
		    };
		
		    // let's say we want a small map to be displayed, so let's create and add it to the map
		    map.smallMap = new AmCharts.SmallMap();
		
		    // write the map to container div
		    map.write("mapdiv");               
		    
		});
        
    </script>
  </head>
  <body>
    <h1>DB Visual Music Player</h1>
	<div id="mapdiv" style="width: 60%; background-color:#EEEEEE; height: 500px; float:left; margin-bottom: 20px"></div>      
	<div style="display : none;">
    <form action='/' method='post' id='countrySubmit'>

	    <table>
	    <tr>
	    	<td>Country</td>
	    	<td> <input type="text" name="country" id="country" value="{{ country_name }}"></td>
	    </tr>
	    <tr>
	    	<td>From</td>
	    	<td><input type="text" name="fromYear" id="fromYear" value="{{ from_year }}"></td>
	    </tr>
	    <tr>
	    	<td>To</td>
	    	<td><input type="text" name="toYear" id="toYear" value="{{ to_year }}"></td>
	    </tr>
	    <tr>
	    	<td>Options</td>
	    	<td><input type="text" name="options" id="options" value="Random"></td>
	    </tr>
	    <tr>
	    	<td><input type="submit" value="Submit" id="submitButton"></td>
	   	</tr>
	    </table>
    </form>
    </div>

    <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
    <!--<div id="player" style="display : none;"></div>-->
    <div id="player" style="display : none; width: 38%; float: right; margin-top: 55px; margin-bottom: 55px"></div>
    <div id="nosong" style="display : none; width: 38%; float: right;">No song from selected country for time period</div>
    <div id="songDetails" style="display : none; width: 38%; float: right;">
    	<table>
    		<tr>
    			<td>Song Name</td>
    			<td id="songName"></td>
    		</tr>
    		<tr>
    			<td>Country</td>
    			<td id="songCountry"></td>
    		</tr>
    		<tr>
    			<td>Language</td>
    			<td id="songLanguage"></td>
    		</tr>
    		<tr>
    			<td>ReleaseDate</td>
    			<td id="releaseDate"></td>
    		</tr>
    	</table>
    </div>

	<!-- Adding new slider --> 

	<p style="clear: both; width: 60%;">
	  <label for="yearrange">Year Range:</label>
	  <input type="text" id="yearrange" readonly style="border:0; color:#f6931f; font-weight:bold;">
	</p>
	<div id="slider-range" style="width: 60%;"></div>

	</br>

	<div id='countrySelected'></div>

	<!-- Selectable Tags -->
    <ol id="selectable">
	  <li class="ui-widget-content">TopArtists</li>
	  <li class="ui-widget-content">TopGenres</li>
	</ol>
	<p>Default: Plays random songs by default. Ctrl click to deselect</p>


	<!--ADDING AJAX CALLS ON SUBMIT-->
    <!-- Overriding submit with ajax call-->
    <script type="text/javascript">
	    $(document).ready(function  () {

		 	$("#countrySubmit").submit(function  (e) {
		 		e.preventDefault();
		 		console.log();
		 		$.post("/",$(this).serialize(), function( data ) {
				  checkSongExists(data);
				});
		 	})
		 });
    </script>
    
    <!--Inserting method to get country, change from Year and To Year values with year validation-->
    <script type="text/javascript">

    //Slider Handler Function
	  $(function() {
	    $( "#slider-range" ).slider({
	      range: true,
	      min: 1900,
	      max: 2015,
	      values: [ 1900, 2015 ],
	      slide: function( event, ui ) {
	        $( "#yearrange" ).val( ui.values[ 0 ] + " - " + ui.values[ 1 ] );
	      },
	      stop: function( event, ui ) {
	      	//call submit only after slider stops
	      	document.getElementById("fromYear").value = ui.values[ 0 ];
	      	document.getElementById("toYear").value = ui.values[ 1 ];
	      	submitForm();
	      }
	    });
	    $( "#yearrange" ).val( $( "#slider-range" ).slider( "values", 0 ) +
	      " - " + $( "#slider-range" ).slider( "values", 1 ) );
	  });


    	//This function is called from ammap.js "clickMapObject" function
    	function getCountry(country){
    		document.getElementById('country').value = country;	
    		document.getElementById('countrySelected').innerHTML = "Country selected: "+country;
    		submitForm();
    	}
 
		//TODO - CHANGE QUERY TYPE DEPENDING ON SELECTION 
		function submitForm(){
			if(document.getElementById('country').value != "None"){
				//Not sure why direct submit is not working. Clicking submit is being overridden in ajax call above
				//document.getElementById("countrySubmit").submit();
				document.getElementById("submitButton").click();
			}
		}
		//checks if a valid songId is returned before displaying player block and playing it
		function checkSongExists(data){
			//strip double quotes from the string returned from server
			if(data == "\"NoSongsReturned\""){
			  	document.getElementById("nosong").style.display = 'block';
			  	document.getElementById("player").style.display = 'none';  	
			  	document.getElementById("songDetails").style.display = 'none'; 
			  	stopVideo();
			}
			else{
				var songDetails = JSON.parse(data);
				setSongDetails(songDetails);
				document.getElementById("nosong").style.display = 'none';
			  	document.getElementById("player").style.display = 'block';
			  	document.getElementById("songDetails").style.display = 'block'; 
			  	playReceivedSong(songDetails.url);	
			}
		}
		//sets song details in the table
		function setSongDetails(songDetails){
			document.getElementById('songName').innerHTML = ": " + songDetails.songName;
			document.getElementById('songCountry').innerHTML = ": " + songDetails.songCountry;
			document.getElementById('songLanguage').innerHTML = ": " + songDetails.songLanguage;
			document.getElementById('releaseDate').innerHTML = ": " + songDetails.releaseDate;
		}
	</script>
    <script>
      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      var player;
      function onYouTubeIframeAPIReady(youtube_link) {
        player = new YT.Player('player', {
          height: '390',
          width: '640',
          videoId: '{{ youtube_link }}',
          videoId: youtube_link,
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      // 4. The API will call this function when the video player is ready.
      function onPlayerReady(event) {
        event.target.playVideo();
      }

      // 5. The API calls this function when the player's state changes.
      //    The function indicates that when playing a video (state=1),
      //    the player should play for six seconds and then stop.
      var done = false;
      function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING && !done) {
          //setTimeout(stopVideo, 6000);
          done = true;
        }
        //SUBMIT Form again once playing completed to fetch new randomsup song
        if(event.data == YT.PlayerState.ENDED){
        	submitForm();
        }
      }
      function stopVideo() {
        player.stopVideo();
      }
      //play song received by AJAX request
      function playReceivedSong(videoId){
		player.loadVideoById(videoId);
      }
    </script>
    <!--Selectable scripts -->
    <!-- Option is random by default --> 
    <!-- unselecting the option defaults it back to random -->
    <script>
	  $(function() {
	    $( "#selectable" ).selectable({
		  selected: function( event, ui ) {
		  	document.getElementById("options").value = ui.selected.innerHTML;
		  	document.getElementById("submitButton").click();
		  },
		  unselected: function( event, ui ) {
		  	document.getElementById("options").value = "Random";
		  	document.getElementById("submitButton").click();
		  }
		});
	  });
  </script>
  </body>
</html>